From a820dbeac29d330bae4be05d9ecd939ad6b4aa33 Mon Sep 17 00:00:00 2001
From: Pranjal Jumde <pjumde@apple.com>
Date: Tue, 1 Mar 2016 11:34:04 -0800
Subject: Bug 758605: Heap-based buffer overread in xmlDictAddString
 <https://bugzilla.gnome.org/show_bug.cgi?id=758605>

Reviewed by David Kilzer.

* HTMLparser.c:
(htmlParseName): Add bounds check.
(htmlParseNameComplex): Ditto.
* result/HTML/758605.html: Added.
* result/HTML/758605.html.err: Added.
* result/HTML/758605.html.sax: Added.
* runtest.c:
(pushParseTest): The input for the new test case was so small
(4 bytes) that htmlParseChunk() was never called after
htmlCreatePushParserCtxt(), thereby creating a false positive
test failure.  Fixed by using a do-while loop so we always call
htmlParseChunk() at least once.
* test/HTML/758605.html: Added.
---
 HTMLparser.c                |  8 ++++++++
 result/HTML/758605.html     |  3 +++
 result/HTML/758605.html.err |  3 +++
 result/HTML/758605.html.sax | 13 +++++++++++++
 runtest.c                   |  4 ++--
 test/HTML/758605.html       |  1 +
 6 files changed, 30 insertions(+), 2 deletions(-)
 create mode 100644 result/HTML/758605.html
 create mode 100644 result/HTML/758605.html.err
 create mode 100644 result/HTML/758605.html.sax
 create mode 100644 test/HTML/758605.html

Index: libxml2-2.9.3+dfsg1/HTMLparser.c
===================================================================
--- libxml2-2.9.3+dfsg1.orig/HTMLparser.c	2016-06-03 08:00:49.064670606 -0400
+++ libxml2-2.9.3+dfsg1/HTMLparser.c	2016-06-03 08:00:49.060670558 -0400
@@ -2472,6 +2472,10 @@
 	       (*in == '_') || (*in == '-') ||
 	       (*in == ':') || (*in == '.'))
 	    in++;
+
+	if (in == ctxt->input->end)
+	    return(NULL);
+
 	if ((*in > 0) && (*in < 0x80)) {
 	    count = in - ctxt->input->cur;
 	    ret = xmlDictLookup(ctxt->dict, ctxt->input->cur, count);
@@ -2515,6 +2519,10 @@
 	NEXTL(l);
 	c = CUR_CHAR(l);
     }
+
+    if (ctxt->input->base > ctxt->input->cur - len)
+	return(NULL);
+
     return(xmlDictLookup(ctxt->dict, ctxt->input->cur - len, len));
 }
 
